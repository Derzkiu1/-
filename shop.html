<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: black; color: white; font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
        .header { padding: 10px; background-color: #000; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); position: relative; }
        .shop-container { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; }
        .item { margin: 20px; border: 2px solid #fff; border-radius: 10px; padding: 10px; width: calc(40% - 40px); max-width: 200px; background: rgba(255, 255, 255, 0.1); cursor: pointer; transition: transform 0.3s; }
        .item:hover { transform: scale(1.05); }
        .item img { width: 100%; height: auto; border-radius: 10px; }
        .item .price { color: gold; font-weight: bold; margin: 10px 0; }
        .level-bar { width: 100%; background-color: #444; border-radius: 5px; margin: 5px 0; }
        .level-progress { height: 10px; background-color: gold; border-radius: 5px; }
        .level-label { margin-top: 5px; }
        .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; border-radius: 10px; padding: 20px; display: none; }
        .popup h2 { margin: 0 0 10px; }
        .popup .close-btn { background: red; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        .popup .upgrade-btn { background: orange; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; margin-top: 10px; }
        .popup .upgrade-btn:disabled { background: gray; cursor: not-allowed; }
        .balance { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <button onclick="window.location.href='index.html'" style="position: absolute; left: 10px;"><i class="fas fa-arrow-left"></i></button>
        <h1>Shop</h1>
        <p class="balance" id="balance">Balance: 0 Coins</p>
    </div>
    <div class="shop-container" id="shop-container">
        <!-- Items will be dynamically added here -->
    </div>
    <div class="popup" id="item-popup">
        <h2 id="popup-title">Item Title</h2>
        <p id="popup-profit">Profit: 0 Coins/min</p>
        <p id="popup-population">Population: 0/min</p>
        <button class="upgrade-btn" id="upgrade-btn" onclick="upgradeItem()">Upgrade</button>
        <button class="close-btn" onclick="closePopup()">Close</button>
    </div>

    <script>
        let currentUser = {
            "user_id": 1,
            "username": "player1",
            "first_name": "Player 1",
            "league": "Начинающий",
            "balance": 0,
            "population": 0,
            "totalProfit": 0,
            "items": [
                { "name": "Помощь бедным", "price": 100, "priceIncrement": 25, "profit": 25, "profitIncrement": 2.5, "population": 10, "populationIncrement": 1, "level": 0 }
            ]
        };

        let selectedItemIndex = null;

        async function loadUserData() {
            try {
                const response = await fetch('users.json');
                if (!response.ok) {
                    throw new Error('Failed to load user data');
                }
                const userData = await response.json();
                currentUser = userData.find(user => user.user_id === currentUser.user_id);
                if (currentUser) {
                    updateBalanceDisplay();
                    initializeShop();
                } else {
                    throw new Error('User data not found');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('balance');
            balanceElement.textContent = `Balance: ${currentUser.balance} Coins`;
        }

        function initializeShop() {
            const shopContainer = document.getElementById('shop-container');
            shopContainer.innerHTML = '';

            currentUser.items.forEach((item, index) => {
                const itemPrice = item.price + item.priceIncrement * item.level;
                const itemElement = document.createElement('div');
                itemElement.classList.add('item');
                itemElement.innerHTML = `
                    <img src="https://via.placeholder.com/200" alt="${item.name}">
                    <p class="price">Price: ${itemPrice} Coins</p>
                    <div class="level-bar">
                        <div class="level-progress" style="width: ${item.level * 10}%"></div>
                    </div>
                    <p class="level-label">Level ${item.level}</p>
                `;
                itemElement.onclick = () => openPopup(index);
                shopContainer.appendChild(itemElement);
            });
        }

        function openPopup(index) {
            selectedItemIndex = index;
            const item = currentUser.items[index];
            const popup = document.getElementById('item-popup');
            const upgradeButton = document.getElementById('upgrade-btn');
            const itemPrice = item.price + item.priceIncrement * item.level;

            document.getElementById('popup-title').textContent = item.name;
            document.getElementById('popup-profit').textContent = `Profit: ${item.profit} Coins/min`;
            document.getElementById('popup-population').textContent = `Population: ${item.population}/min`;

            if (currentUser.balance >= itemPrice && item.level < 10) {
                upgradeButton.disabled = false;
            } else {
                upgradeButton.disabled = true;
            }

            popup.style.display = 'block';
        }

        function closePopup() {
            document.getElementById('item-popup').style.display = 'none';
        }

        async function upgradeItem() {
            if (selectedItemIndex === null) return;

            const item = currentUser.items[selectedItemIndex];
            const itemPrice = item.price + item.priceIncrement * item.level;

            console.log('Before upgrade:', currentUser);

            if (currentUser.balance >= itemPrice && item.level < 10) {
                currentUser.balance -= itemPrice;
                item.level++;
                item.price += item.priceIncrement; // Обновляем цену после улучшения
                item.profit = Math.round(item.profit * 1.1);
                item.population = Math.round(item.population * 1.1);
                currentUser.totalProfit += item.profit;
                currentUser.population += item.population;

                await saveUserData();

                console.log('After upgrade:', currentUser);

                updateBalanceDisplay();
                initializeShop();
                closePopup();
            }
        }

        function saveUserData() {
            localStorage.setItem('userData', JSON.stringify(currentUser));
        }

        function earnProfit() {
            currentUser.items.forEach(item => {
                currentUser.balance += item.profit;
            });

            saveUserData();
            updateBalanceDisplay();
        }

        window.onload = function() {
            loadUserData();
            setInterval(earnProfit, 60000); // Начисление дохода каждую минуту
        };
    </script>
</body>
</html>
